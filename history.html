<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan History - OralScan AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar-menu {
            display: flex;
            gap: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            color: white;
            font-size: 36px;
            margin-bottom: 30px;
        }

        .filter-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .scan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .scan-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .scan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .scan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .scan-id {
            font-size: 12px;
            color: #999;
        }

        .scan-date {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .risk-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
        }

        .risk-high { background: #dc3545; }
        .risk-moderate { background: #ffc107; }
        .risk-low { background: #28a745; }

        .scan-info {
            margin-bottom: 15px;
        }

        .scan-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .scan-info-label {
            color: #666;
        }

        .scan-info-value {
            font-weight: 600;
            color: #333;
        }

        .scan-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view { background: #667eea; color: white; }
        .btn-download { background: #28a745; color: white; }
        .btn-analyze { background: #ff6b6b; color: white; }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
        }

        .chart-container {
            height: 350px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="logo.png" alt="Logo" style="height: 120px; width: auto;">
            <span>ORISCOPE</span>
        </div>

        <div class="navbar-menu">
            <a href="dashboard.html" class="nav-btn">‚Üê Dashboard</a>
            <a href="scan.html" class="nav-btn">New Scan</a>
            <a href="dual_scan_fixed.html" class="nav-btn">Dual Scan</a>
            <a href="analysis.html" class="nav-btn">Analysis</a>
            <a href="export.html" class="nav-btn">Export</a>
        </div>
    </nav>

    <div class="container">
        <h1>üìã Scan History</h1>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Filter by Risk:</label>
                <select id="riskFilter">
                    <option value="all">All Risks</option>
                    <option value="high">High Risk</option>
                    <option value="moderate">Moderate Risk</option>
                    <option value="low">Low Risk</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sortBy">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="risk-high">Risk (High to Low)</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="searchBox" placeholder="Search scans...">
            </div>

            <div class="filter-group">
                <label>Patient:</label>
                <input type="text" id="patientSearch" placeholder="Search by patient name...">
            </div>
        </div>

        <div id="scanContainer" class="scan-grid"></div>
    </div>

    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <h2>üìä Scan Analysis</h2>
            <div class="chart-container">
                <canvas id="modalChart"></canvas>
            </div>
            <button onclick="closeModal()" class="nav-btn" style="margin-top:10px;">Close</button>
        </div>
    </div>

<script>
var allScans = [];
var currentChart = null;

var uniquePatientNames = [
    "Rahul Sharma","Ananya Singh","Vikram Patel","Neha Verma","Amit Kumar",
    "Priya Desai","Rohit Mehta","Sneha Iyer","Karan Joshi","Pooja Nair",
    "Arjun Malhotra","Tara Kapoor","Siddharth Rao","Divya Chauhan","Manav Thakur",
    "Rhea Bansal","Aditya Khanna","Sana Sheikh","Kavya Nambiar","Ishaan Sen",
    "Kritika Arora","Rohan Batra","Simran Purohit","Dhruv Menon","Aarav Narang",
    "Meera Kulkarni","Ayush Anand","Harini Raj","Gaurav Jain","Nikita Vaidya",
    "Shivani Reddy","Pranav Shah","Tanvi Wadhwa","Kabir Kohli","Radhika Pillai",
    "Yash Rajput","Anjali Naidu","Zoya Merchant","Farhan Qureshi",
    "Aman Trivedi","Krish Chhabra","Arnav Kapoor","Varun Kulkarni","Sameer Banerjee",
    "Harsh Vaidya","Tanishq Ghosh","Sarthak Rane","Keshav Shetty","Omkar Bhosale",
    "Tejas Pawar","Viren D'Souza","Jatin Barot","Ishita Dube","Mallika Sethi",
    "Ayesha Qureshi","Ruhi Mathur","Shreya Borkar","Aditi Chatterjee","Avantika Anand"
];

function safeLoadLocalScans() {
    try {
        var data = JSON.parse(localStorage.getItem("userScans") || "[]");
        return Array.isArray(data) ? data : [];
    } catch (e) {
        return [];
    }
}

function createSampleScans() {
    var sampleScans = [];
    var riskLevels = ['low', 'moderate', 'high'];
    var scanTypes = ['autofluorescence', 'normal'];
    var regions = ['Upper Oral Cavity','Lower Oral Cavity','Left Buccal','Right Buccal','Tongue'];

    var names = uniquePatientNames.slice();
    for (var i = names.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = names[i];
        names[i] = names[j];
        names[j] = temp;
    }
    names = names.slice(0, 20);

    for (var i = 0; i < 20; i++) {
        var randomDaysAgo = Math.floor(Math.random() * 14);
        var randomHours = Math.floor(Math.random() * 24);
        var randomMinutes = Math.floor(Math.random() * 60);
        var randomSeconds = Math.floor(Math.random() * 60);

        var date = new Date();
        date.setDate(date.getDate() - randomDaysAgo);
        date.setHours(randomHours, randomMinutes, randomSeconds, 0);

        var randomTimestamp = date.toISOString();
        
        var patientName = names[i];

        sampleScans.push({
            id: "scan_" + Date.now() + "_" + i + "_" + Math.random().toString(36).substr(2, 9),
            timestamp: randomTimestamp,
            patientName: patientName,
            riskLevel: riskLevels[i % 3],
            riskPercentage: Number((Math.random() * 100).toFixed(1)),
            confidence: Number((0.75 + Math.random() * 0.2).toFixed(2)),
            scanType: scanTypes[i % 2],
            lesions: [
                { id: 1, region: regions[i % regions.length], size: "12mm¬≤", severity: "mild" }
            ],
            clinicalNotes: {
                diagnosis: "Normal",
                findings: "Healthy fluorescence",
                recommendation: "Routine check"
            }
        });
    }

    return sampleScans;
}

function loadScans() {
    var data = safeLoadLocalScans();

    if (data.length === 0) {
        var samples = createSampleScans();
        localStorage.setItem("userScans", JSON.stringify(samples));
        data = samples;
    }

    allScans = data;

    allScans = allScans.map(function(s) {
        if (!Array.isArray(s.lesions)) {
            s.lesions = [];
        }
        if (!s.patientName || s.patientName === "Unknown" || s.patientName === "") {
            var randomIndex = Math.floor(Math.random() * uniquePatientNames.length);
            s.patientName = uniquePatientNames[randomIndex];
        }
        return s;
    });

    applyFilters();
}

function findScanById(id) {
    for (var i = 0; i < allScans.length; i++) {
        if (allScans[i].id === id) {
            return allScans[i];
        }
    }
    return null;
}

function displayScans(scans) {
    var container = document.getElementById('scanContainer');

    if (!scans || scans.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h2>No Scans Found</h2></div>';
        return;
    }

    var html = '';

    for (var i = 0; i < scans.length; i++) {
        var scan = scans[i];
        var date = new Date(scan.timestamp).toLocaleString();
        var scanIdShort = scan.id.substring(0, 20);

        html += '<div class="scan-card">';
        html += '  <div class="scan-header">';
        html += '    <div>';
        html += '      <div class="scan-id">ID: ' + scanIdShort + '...</div>';
        html += '      <div class="scan-date">' + date + '</div>';
        html += '    </div>';
        html += '    <span class="risk-badge risk-' + scan.riskLevel + '">' + scan.riskLevel.toUpperCase() + '</span>';
        html += '  </div>';
        html += '  <div class="scan-info">';
        html += '    <div class="scan-info-row">';
        html += '      <span class="scan-info-label">Patient:</span>';
        html += '      <span class="scan-info-value">' + scan.patientName + '</span>';
        html += '    </div>';
        html += '    <div class="scan-info-row">';
        html += '      <span class="scan-info-label">Risk:</span>';
        html += '      <span class="scan-info-value">' + scan.riskPercentage + '%</span>';
        html += '    </div>';
        html += '    <div class="scan-info-row">';
        html += '      <span class="scan-info-label">Confidence:</span>';
        html += '      <span class="scan-info-value">' + (scan.confidence * 100).toFixed(0) + '%</span>';
        html += '    </div>';
        html += '    <div class="scan-info-row">';
        html += '      <span class="scan-info-label">Type:</span>';
        html += '      <span class="scan-info-value">' + scan.scanType + '</span>';
        html += '    </div>';
        html += '    <div class="scan-info-row">';
        html += '      <span class="scan-info-label">Lesions:</span>';
        html += '      <span class="scan-info-value">' + scan.lesions.length + '</span>';
        html += '    </div>';
        html += '  </div>';
        html += '  <div class="scan-actions">';
        html += '    <button class="action-btn btn-view" data-scan-id="' + scan.id + '">üëÅÔ∏è View</button>';
        html += '    <button class="action-btn btn-analyze" data-scan-id="' + scan.id + '">üìä Analyze</button>';
        html += '    <button class="action-btn btn-download" data-scan-id="' + scan.id + '">üì• Download</button>';
        html += '  </div>';
        html += '</div>';
    }

    container.innerHTML = html;

    attachButtonListeners();
}

function handleViewClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    var msg = 'SCAN DETAILS\n\n';
    msg += 'ID: ' + scan.id + '\n';
    msg += 'Patient: ' + scan.patientName + '\n';
    msg += 'Date: ' + new Date(scan.timestamp).toLocaleString() + '\n';
    msg += 'Risk: ' + scan.riskLevel.toUpperCase() + ' (' + scan.riskPercentage + '%)\n';
    msg += 'Confidence: ' + (scan.confidence * 100).toFixed(0) + '%\n';
    msg += 'Type: ' + scan.scanType + '\n\n';
    msg += 'DIAGNOSIS:\n' + scan.clinicalNotes.diagnosis + '\n\n';
    msg += 'FINDINGS:\n' + scan.clinicalNotes.findings + '\n\n';
    msg += 'RECOMMENDATION:\n' + scan.clinicalNotes.recommendation + '\n\n';
    msg += 'LESIONS (' + scan.lesions.length + '):\n';

    for (var i = 0; i < scan.lesions.length; i++) {
        var l = scan.lesions[i];
        msg += (i + 1) + '. ' + l.region + ' - ' + l.size + ' (' + l.severity + ')\n';
    }

    alert(msg);
}

function handleAnalyzeClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    document.getElementById("analysisModal").classList.add("active");

    setTimeout(function() {
        createChart(scan);
    }, 100);
}

function handleDownloadClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    var report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    report += '           ORAL CANCER SCREENING REPORT\n';
    report += '           OralScan AI Detection System\n';
    report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
    report += 'PATIENT INFORMATION\n';
    report += 'Patient Name: ' + scan.patientName + '\n\n';
    report += 'SCAN INFORMATION\n';
    report += 'Date: ' + new Date(scan.timestamp).toLocaleString() + '\n';
    report += 'Scan Type: ' + scan.scanType.toUpperCase() + '\n';
    report += 'Scan ID: ' + scan.id + '\n\n';
    report += 'RISK ASSESSMENT\n';
    report += 'Risk Level: ' + scan.riskLevel.toUpperCase() + '\n';
    report += 'Risk Percentage: ' + scan.riskPercentage + '%\n';
    report += 'Confidence: ' + (scan.confidence * 100).toFixed(0) + '%\n\n';
    report += 'CLINICAL NOTES\n';
    report += 'Diagnosis: ' + scan.clinicalNotes.diagnosis + '\n';
    report += 'Findings: ' + scan.clinicalNotes.findings + '\n';
    report += 'Recommendation: ' + scan.clinicalNotes.recommendation + '\n\n';
    report += 'DETECTED LESIONS (' + scan.lesions.length + ' Total)\n';

    for (var i = 0; i < scan.lesions.length; i++) {
        var l = scan.lesions[i];
        report += '\nLesion ' + (i + 1) + ':\n';
        report += '  Region: ' + l.region + '\n';
        report += '  Size: ' + l.size + '\n';
        report += '  Severity: ' + l.severity.toUpperCase() + '\n';
    }

    report += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
    report += 'Generated by OralScan AI ¬© 2024\n';
    report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê';

    var blob = new Blob([report], { type: "text/plain" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = 'OralScan_Report_' + scan.patientName + '_' + scan.id.substring(0, 15) + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('‚úì Report downloaded successfully!');
}

function createChart(scan) {
    if (currentChart) {
        currentChart.destroy();
    }

    var ctx = document.getElementById('modalChart');

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Risk', 'Confidence', 'Lesions (x10)'],
            datasets: [{
                data: [
                    scan.riskPercentage,
                    scan.confidence * 100,
                    scan.lesions.length * 10
                ],
                backgroundColor: [
                    scan.riskLevel === 'high' ? '#dc3545' : 
                    scan.riskLevel === 'moderate' ? '#ffc107' : '#28a745',
                    '#667eea',
                    '#764ba2'
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });
}

function attachButtonListeners() {
    var viewButtons = document.querySelectorAll('.btn-view');
    for (var i = 0; i < viewButtons.length; i++) {
        viewButtons[i].addEventListener('click', handleViewClick);
    }

    var analyzeButtons = document.querySelectorAll('.btn-analyze');
    for (var i = 0; i < analyzeButtons.length; i++) {
        analyzeButtons[i].addEventListener('click', handleAnalyzeClick);
    }

    var downloadButtons = document.querySelectorAll('.btn-download');
    for (var i = 0; i < downloadButtons.length; i++) {
        downloadButtons[i].addEventListener('click', handleDownloadClick);
    }
}

function applyFilters() {
    var riskFilter = document.getElementById('riskFilter').value;
    var sortBy = document.getElementById('sortBy').value;
    var searchTerm = document.getElementById('searchBox').value.toLowerCase();
    var patientTerm = document.getElementById('patientSearch').value.toLowerCase();

    var filtered = allScans.slice();

    if (riskFilter !== 'all') {
        filtered = filtered.filter(function(s) {
            return s.riskLevel === riskFilter;
        });
    }

    if (searchTerm) {
        filtered = filtered.filter(function(s) {
            return s.id.toLowerCase().includes(searchTerm) ||
                   s.scanType.toLowerCase().includes(searchTerm);
        });
    }

    if (patientTerm) {
        filtered = filtered.filter(function(s) {
            return (s.patientName || "").toLowerCase().includes(patientTerm);
        });
    }

    if (sortBy === "newest") {
        filtered.sort(function(a, b) {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
    } else if (sortBy === "oldest") {
        filtered.sort(function(a, b) {
            return new Date(a.timestamp) - new Date(b.timestamp);
        });
    } else if (sortBy === "risk-high") {
        var order = { high: 3, moderate: 2, low: 1 };
        filtered.sort(function(a, b) {
            return order[b.riskLevel] - order[a.riskLevel];
        });
    }

    displayScans(filtered);
}

function closeModal() {
    document.getElementById('analysisModal').classList.remove('active');
    if (currentChart) {
        currentChart.destroy();
    }
}

var lastLocalValue = localStorage.getItem("userScans");

function watchLocalScans() {
    var currentValue = localStorage.getItem("userScans");

    if (currentValue !== lastLocalValue) {
        lastLocalValue = currentValue;
        loadScans();
    }
}

window.addEventListener('load', function() {
    loadScans();
    setInterval(watchLocalScans, 500);
});

document.getElementById('riskFilter').addEventListener('change', applyFilters);
document.getElementById('sortBy').addEventListener('change', applyFilters);
document.getElementById('searchBox').addEventListener('input', applyFilters);
document.getElementById('patientSearch').addEventListener('input', applyFilters);

</script>

</body>
</html>
