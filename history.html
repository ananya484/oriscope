<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan History - OralScan AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .navbar-menu {
            display: flex;
            gap: 20px;
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            color: white;
            font-size: 36px;
            margin-bottom: 30px;
        }

        .filter-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .scan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .scan-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .scan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .scan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .scan-id {
            font-size: 12px;
            color: #999;
        }

        .scan-date {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .risk-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
        }

        .risk-high { background: #dc3545; }
        .risk-moderate { background: #ffc107; }
        .risk-low { background: #28a745; }

        .scan-info {
            margin-bottom: 15px;
        }

        .scan-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .scan-info-label {
            color: #666;
        }

        .scan-info-value {
            font-weight: 600;
            color: #333;
        }

        .scan-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view { background: #667eea; color: white; }
        .btn-download { background: #28a745; color: white; }
        .btn-analyze { background: #ff6b6b; color: white; }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
        }

        .chart-container {
            height: 350px;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <img src="logo.png" alt="Logo" style="height: 120px; width: auto;">
            <span>ORISCOPE</span>
        </div>

        <div class="navbar-menu">
            <a href="dashboard.html" class="nav-btn">‚Üê Dashboard</a>
            <a href="scan.html" class="nav-btn">New Scan</a>
            <a href="analysis.html" class="nav-btn">analysis</a>
<a href="export.html" class="nav-btn">export</a>

        </div>
    </nav>

    <div class="container">
        <h1>üìã Scan History</h1>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Filter by Risk:</label>
                <select id="riskFilter">
                    <option value="all">All Risks</option>
                    <option value="high">High Risk</option>
                    <option value="moderate">Moderate Risk</option>
                    <option value="low">Low Risk</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sortBy">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="risk-high">Risk (High to Low)</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="searchBox" placeholder="Search scans...">
            </div>

            <div class="filter-group">
                <label>Patient:</label>
                <input type="text" id="patientSearch" placeholder="Search by patient name..." onkeyup="filterByPatient()">
            </div>
        </div>

        <div id="scanContainer" class="scan-grid"></div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <h2>üìä Scan Analysis</h2>
            <div class="chart-container">
                <canvas id="modalChart"></canvas>
            </div>
            <button onclick="closeModal()" class="nav-btn" style="margin-top:10px;">Close</button>
        </div>
    </div>

<script>
/* ======================================================================
   GLOBALS
====================================================================== */
var allScans = [];
var currentChart = null;

/* ======================================================================
   UNIQUE NAMES ‚Äî NO REPEAT
====================================================================== */
/* ======================================================================
   UNIQUE NAMES ‚Äî NO REPEAT
====================================================================== */
const uniquePatientNames = [
    "Rahul Sharma","Ananya Singh","Vikram Patel","Neha Verma","Amit Kumar",
    "Priya Desai","Rohit Mehta","Sneha Iyer","Karan Joshi","Pooja Nair",
    "Arjun Malhotra","Tara Kapoor","Siddharth Rao","Divya Chauhan","Manav Thakur",
    "Rhea Bansal","Aditya Khanna","Sana Sheikh","Kavya Nambiar","Ishaan Sen",
    "Kritika Arora","Rohan Batra","Simran Purohit","Dhruv Menon","Aarav Narang",
    "Meera Kulkarni","Ayush Anand","Harini Raj","Gaurav Jain","Nikita Vaidya",
    "Shivani Reddy","Pranav Shah","Tanvi Wadhwa","Kabir Kohli","Radhika Pillai",
    "Yash Rajput","Anjali Naidu","Zoya Merchant","Farhan Qureshi",

    "Aman Trivedi","Krish Chhabra","Arnav Kapoor","Varun Kulkarni","Sameer Banerjee",
    "Harsh Vaidya","Tanishq Ghosh","Sarthak Rane","Keshav Shetty","Omkar Bhosale",
    "Tejas Pawar","Viren D‚ÄôSouza","Jatin Barot","Ishita Dube","Mallika Sethi",
    "Ayesha Qureshi","Ruhi Mathur","Shreya Borkar","Aditi Chatterjee","Avantika Anand"
];

/* ======================================================================
   SAFE LOAD FUNCTION ‚Äî prevents reset to 0
====================================================================== */
function safeLoadLocalScans() {
    try {
        const data = JSON.parse(localStorage.getItem("userScans") || "[]");
        return Array.isArray(data) ? data : [];
    } catch {
        return [];
    }
}

/* ======================================================================
   SAMPLE SCANS ‚Äî only if storage empty
====================================================================== */
function createSampleScans() {
    var sampleScans = [];
    var riskLevels = ['low', 'moderate', 'high'];
    var scanTypes = ['autofluorescence', 'normal'];
    var regions = ['Upper Oral Cavity','Lower Oral Cavity','Left Buccal','Right Buccal','Tongue'];

    // SHUFFLE NAMES ONCE & USE FIRST 20
    let names = [...uniquePatientNames];
    for (let i = names.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [names[i], names[j]] = [names[j], names[i]];
    }
    names = names.slice(0, 20); // ensures uniqueness

    for (let i = 0; i < 20; i++) {

        // ‚≠ê RANDOM DATE IN LAST 14 DAYS (2 weeks)
        const randomDaysAgo = Math.floor(Math.random() * 14);  // 0‚Äì13 days
        const randomHours = Math.floor(Math.random() * 24);
        const randomMinutes = Math.floor(Math.random() * 60);
        const randomSeconds = Math.floor(Math.random() * 60);

        const date = new Date();
        date.setDate(date.getDate() - randomDaysAgo);
        date.setHours(randomHours, randomMinutes, randomSeconds, 0);

        const randomTimestamp = date.toISOString();

        sampleScans.push({
            id: "scan_" + crypto.randomUUID(),   // ‚≠ê guaranteed unique ID
            timestamp: randomTimestamp,          // ‚≠ê new timestamp
            riskLevel: riskLevels[i % 3],
            riskPercentage: Number((Math.random() * 100).toFixed(1)),
            confidence: Number((0.75 + Math.random() * 0.2).toFixed(2)),
            scanType: scanTypes[i % 2],
            lesions: [
                { id: 1, region: "Tongue", size: "12mm¬≤", severity: "mild" }
            ],
            patientName: names[i],  // ‚≠ê guaranteed unique
            clinicalNotes: {
                diagnosis: "Normal",
                findings: "Healthy fluorescence",
                recommendation: "Routine check"
            }
        });
    }

    return sampleScans;
}


/* ======================================================================
   LOAD SCANS (real + sample)
====================================================================== */
function loadScans() {
    var data = safeLoadLocalScans();

    if (data.length === 0) {
        const samples = createSampleScans();
        localStorage.setItem("userScans", JSON.stringify(samples));
        data = samples;
    } else {
        // NEVER overwrite or recreate anything again
    }

    allScans = data;

    // üî• FIX: Guarantee lesions always exists
    allScans = allScans.map(s => {
        if (!Array.isArray(s.lesions)) {
            s.lesions = [];
        }
        return s;
    });

    applyFilters();
}
/* ======================================================================
   FIND BY ID
====================================================================== */
function findScanById(id) {
    return allScans.find(s => s.id === id);
}

/* ======================================================================
   DISPLAY CARDS ‚Äî ORIGINAL RESTORED
====================================================================== */
function displayScans(scans) {
    var container = document.getElementById('scanContainer');

    if (!scans || scans.length === 0) {
        container.innerHTML =
            '<div class="empty-state"><div class="empty-icon">üì≠</div><h2>No Scans</h2></div>';
        return;
    }

    var html = '';

    for (var i=0; i<scans.length; i++) {
        var scan = scans[i];
        var date = new Date(scan.timestamp).toLocaleString();

        html += `
        <div class="scan-card">
            <div class="scan-header">
                <div>
                    <div class="scan-id">ID: ${scan.id.substring(0,20)}...</div>
                    <div class="scan-date">${date}</div>
                </div>
                <span class="risk-badge risk-${scan.riskLevel}">${scan.riskLevel.toUpperCase()}</span>
            </div>

            <div class="scan-info">
                <div class="scan-info-row">
                    <span class="scan-info-label">Patient:</span>
                    <span class="scan-info-value">${scan.patientName}</span>
                </div>
                <div class="scan-info-row">
                    <span class="scan-info-label">Risk:</span>
                    <span class="scan-info-value">${scan.riskPercentage}%</span>
                </div>
                <div class="scan-info-row">
                    <span class="scan-info-label">Confidence:</span>
                    <span class="scan-info-value">${(scan.confidence*100).toFixed(0)}%</span>
                </div>
                <div class="scan-info-row">
                    <span class="scan-info-label">Type:</span>
                    <span class="scan-info-value">${scan.scanType}</span>
                </div>
                <div class="scan-info-row">
                    <span class="scan-info-label">Lesions:</span>
                    <span class="scan-info-value">${scan.lesions.length}</span>
                </div>
            </div>

            <div class="scan-actions">
                <button class="action-btn btn-view" data-scan-id="${scan.id}">üëÅÔ∏è View</button>
                <button class="action-btn btn-analyze" data-scan-id="${scan.id}">üìä Analyze</button>
                <button class="action-btn btn-download" data-scan-id="${scan.id}">üì• Download</button>
            </div>
        </div>`;
    }

    container.innerHTML = html;

    attachButtonListeners();
}

/* ======================================================================
   ORIGINAL VIEW RESTORED
====================================================================== */
function handleViewClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    var msg = 'SCAN DETAILS\n\n';
    msg += 'ID: ' + scan.id + '\n';
    msg += 'Date: ' + new Date(scan.timestamp).toLocaleString() + '\n';
    msg += 'Risk: ' + scan.riskLevel.toUpperCase() + ' (' + scan.riskPercentage + '%)\n';
    msg += 'Confidence: ' + (scan.confidence * 100).toFixed(0) + '%\n';
    msg += 'Type: ' + scan.scanType + '\n\n';
    msg += 'DIAGNOSIS:\n' + scan.clinicalNotes.diagnosis + '\n\n';
    msg += 'FINDINGS:\n' + scan.clinicalNotes.findings + '\n\n';
    msg += 'RECOMMENDATION:\n' + scan.clinicalNotes.recommendation + '\n\n';
    msg += 'LESIONS (' + scan.lesions.length + '):\n';

    for (var i = 0; i < scan.lesions.length; i++) {
        var l = scan.lesions[i];
        msg += (i+1) + '. ' + l.region + ' - ' + l.size + ' (' + l.severity + ')\n';
    }

    alert(msg);
}

/* ======================================================================
   ORIGINAL ANALYZE RESTORED
====================================================================== */
function handleAnalyzeClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    document.getElementById("analysisModal").classList.add("active");

    setTimeout(() => createChart(scan), 100);
}

/* ======================================================================
   ORIGINAL DOWNLOAD RESTORED
====================================================================== */
function handleDownloadClick(e) {
    var id = e.target.getAttribute('data-scan-id');
    var scan = findScanById(id);
    if (!scan) return;

    var report =
`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ORAL CANCER SCREENING REPORT
           OralScan AI Detection System
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SCAN INFORMATION
Date: ${new Date(scan.timestamp).toLocaleString()}
Scan Type: ${scan.scanType.toUpperCase()}
Scan ID: ${scan.id}

RISK ASSESSMENT
Risk Level: ${scan.riskLevel.toUpperCase()}
Risk Percentage: ${scan.riskPercentage}%
Confidence: ${(scan.confidence*100).toFixed(0)}%

CLINICAL NOTES
Diagnosis: ${scan.clinicalNotes.diagnosis}
Findings: ${scan.clinicalNotes.findings}
Recommendation: ${scan.clinicalNotes.recommendation}

DETECTED LESIONS (${scan.lesions.length} Total)
`;

    scan.lesions.forEach((l, i) => {
        report += `
Lesion ${i+1}:
  Region: ${l.region}
  Size: ${l.size}
  Severity: ${l.severity.toUpperCase()}
`;
    });

    report += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Generated by OralScan AI ¬© 2024
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

    var blob = new Blob([report], { type:"text/plain" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = 'OralScan_Report_' + scan.id.substring(0,15) + '.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert('‚úì Report downloaded successfully!');
}

/* ======================================================================
   CHART RESTORED
====================================================================== */
function createChart(scan) {
    if (currentChart) currentChart.destroy();

    var ctx = document.getElementById('modalChart');

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Risk', 'Confidence', 'Lesions (x10)'],
            datasets: [{
                data: [
                    scan.riskPercentage,
                    scan.confidence * 100,
                    scan.lesions.length * 10
                ],
                backgroundColor: [
                    scan.riskLevel === 'high' ? '#dc3545' : 
                    scan.riskLevel === 'moderate' ? '#ffc107' : '#28a745',
                    '#667eea',
                    '#764ba2'
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display:false } },
            scales: { y: { beginAtZero:true, max:100 } }
        }
    });
}

/* ======================================================================
   BUTTON LISTENERS (original)
====================================================================== */
function attachButtonListeners() {
    document.querySelectorAll('.btn-view').forEach(btn =>
        btn.addEventListener('click', handleViewClick)
    );
    document.querySelectorAll('.btn-analyze').forEach(btn =>
        btn.addEventListener('click', handleAnalyzeClick)
    );
    document.querySelectorAll('.btn-download').forEach(btn =>
        btn.addEventListener('click', handleDownloadClick)
    );
}

/* ======================================================================
   FILTERS
====================================================================== */
function applyFilters() {
    var riskFilter = document.getElementById('riskFilter').value;
    var sortBy = document.getElementById('sortBy').value;
    var searchTerm = document.getElementById('searchBox').value.toLowerCase();
    var patientTerm = document.getElementById('patientSearch').value.toLowerCase();

    var filtered = allScans.slice();

    if (riskFilter !== 'all') {
        filtered = filtered.filter(s => s.riskLevel === riskFilter);
    }

    if (searchTerm) {
        filtered = filtered.filter(s =>
            s.id.toLowerCase().includes(searchTerm) ||
            s.scanType.toLowerCase().includes(searchTerm)
        );
    }

    if (patientTerm) {
        filtered = filtered.filter(s =>
            (s.patientName || "").toLowerCase().includes(patientTerm)
        );
    }

    if (sortBy === "newest") {
        filtered.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
    } 
    else if (sortBy === "oldest") {
        filtered.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
    } 
    else if (sortBy === "risk-high") {
        const order = { high:3, moderate:2, low:1 };
        filtered.sort((a,b)=>order[b.riskLevel]-order[a.riskLevel]);
    }

    displayScans(filtered);
}

function filterByPatient() {
    applyFilters();
}

/* ======================================================================
   MODAL CLOSE
====================================================================== */
function closeModal() {
    document.getElementById('analysisModal').classList.remove('active');
    if (currentChart) currentChart.destroy();
}

/* ======================================================================
  let lastLocalValue = localStorage.getItem("userScans");

function watchLocalScans() {
    let currentValue = localStorage.getItem("userScans");

    // Only reload if data actually changed
    if (currentValue !== lastLocalValue) {
        lastLocalValue = currentValue;
        loadScans();  // üî• instantly updates names, lesions, type, etc.
    }
}

// Run immediately
window.addEventListener('load', () => {
    loadScans();
    setInterval(watchLocalScans, 500); // checks 2 times per second
});


document.getElementById('riskFilter').addEventListener('change', applyFilters);
document.getElementById('sortBy').addEventListener('change', applyFilters);
document.getElementById('searchBox').addEventListener('input', applyFilters);
document.getElementById('patientSearch').addEventListener('input', applyFilters);

</script>

</body>
</html>
